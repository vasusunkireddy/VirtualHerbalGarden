<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Admin Dashboard for Virtual Herbal Garden - Manage plants, categories, tours, and learning progress." />
  <title>Admin Dashboard | Virtual Herbal Garden</title>

  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;800&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <style>
    :root{
      --primary-blue:#1E3A8A; --primary-blue-600:#2A5298;
      --secondary-gold:#D4AF37; --bg-0:#E6E8F2; --bg-1:#F5F5F5;
      --text:#2D3748; --muted:#6B7280; --white:#FFFFFF; --danger:#EF4444; --good:#22C55E;
      --card:#ffffff; --border:#e5e7eb;
      --shadow-sm:0 2px 8px rgba(30,58,138,.10);
      --shadow-md:0 4px 16px rgba(30,58,138,.15);
      --radius:14px;
    }
    *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
    html:focus-within{scroll-behavior:smooth}
    @media (prefers-reduced-motion:reduce){
      html:focus-within{scroll-behavior:auto}
      *,*::before,*::after{animation-duration:0.01ms!important;animation-iteration-count:1!important;transition-duration:0.01ms!important;scroll-behavior:auto!important}
    }
    body{
      font-family:'Roboto',system-ui,-apple-system,Segoe UI,Arial,sans-serif;
      background:linear-gradient(135deg,var(--bg-0),var(--bg-1));
      color:var(--text); min-height:100vh; line-height:1.55; overflow-x:hidden; -webkit-font-smoothing:antialiased;
    }
    /* Header */
    header{
      background:linear-gradient(90deg,var(--primary-blue),var(--primary-blue-600));
      color:var(--white); padding:1.25rem 1.5rem; display:flex; align-items:center; justify-content:space-between; gap:1rem; position:sticky; top:0; z-index:20; box-shadow:var(--shadow-md);
    }
    header::before{
      content:''; position:absolute; inset:0; translate:-100% 0; background:linear-gradient(90deg,transparent,rgba(255,255,255,.25),transparent);
      animation:shine 3s linear infinite;
    }
    @keyframes shine{50%{translate:100% 0}100%{translate:100% 0}}
    header .brand{display:flex; align-items:center; gap:.9rem; position:relative; z-index:1}
    header img{height:54px; width:54px; object-fit:cover; border-radius:12px; filter:drop-shadow(0 4px 10px rgba(0,0,0,.18)); transition:transform .2s ease}
    header img:hover{transform:scale(1.04)}
    .title-group{position:relative; z-index:1}
    .title-group h1{font-family:'Playfair Display',serif; font-size:1.9rem; font-weight:800; letter-spacing:.3px}
    .title-group span{display:block; font-size:.95rem; color:var(--secondary-gold); font-weight:600}

    /* Top actions */
    .top-right{display:flex; align-items:center; gap:.75rem; z-index:1}
    .pill{
      display:inline-flex; align-items:center; gap:.5rem; padding:.55rem .9rem; border-radius:999px; background:rgba(255,255,255,.12); color:#fff; border:1px solid rgba(255,255,255,.18);
      font-weight:600; text-decoration:none; transition:opacity .2s ease, transform .2s ease;
    }
    .pill:focus-visible{outline:2px solid #fff; outline-offset:2px}
    .pill:hover{opacity:.9; transform:translateY(-1px)}
    .logout{
      background:linear-gradient(45deg,var(--secondary-gold),#ea3553);
      border:none; padding:.6rem 1.2rem; color:#0f172a; font-weight:800; font-size:1rem; border-radius:10px; cursor:pointer; box-shadow:var(--shadow-sm);
      transition:transform .15s ease, box-shadow .15s ease, filter .15s ease;
    }
    .logout:hover{transform:translateY(-1px); filter:saturate(1.05); box-shadow:var(--shadow-md)}
    .logout:focus-visible{outline:3px solid #fff; outline-offset:2px}

    /* Nav */
    nav{background:var(--primary-blue); display:flex; flex-wrap:wrap; justify-content:center; gap:.25rem; padding:.35rem .5rem; box-shadow:var(--shadow-sm)}
    nav a{
      --pad: .85rem;
      flex:0 1 180px; padding:var(--pad); text-align:center; color:#fff; text-decoration:none; font-size:1.05rem; font-weight:600; letter-spacing:.2px;
      transition:all .2s; border-radius:10px;
    }
    nav a:hover{background:var(--secondary-gold); color:var(--primary-blue); transform:translateY(-2px); box-shadow:var(--shadow-sm)}
    nav a.active{background:#fff; color:var(--primary-blue); box-shadow:var(--shadow-sm)}

    /* Main container */
    .container{max-width:1280px; margin:1.5rem auto 2.5rem; padding:0 1rem}
    .content{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow-md); padding:1.4rem}
    .content h2{font-family:'Playfair Display',serif; font-size:1.9rem; font-weight:800; color:var(--primary-blue); margin-bottom:.35rem; text-align:center}
    .content p.lead{font-size:1.08rem; color:var(--muted); text-align:center; margin-bottom:1.2rem}

    /* Quick Actions */
    .quick-actions{display:grid; grid-template-columns:repeat(4,1fr); gap:.9rem; margin:1.1rem 0 1.2rem}
    .qa{
      background:linear-gradient(180deg,#ffffff,#f8fafc); border:1px solid var(--border); border-radius:12px; padding:1rem; display:flex; align-items:center; gap:.9rem; cursor:pointer;
      box-shadow:var(--shadow-sm); transition:transform .15s ease, box-shadow .15s ease;
    }
    .qa .ico{font-size:1.2rem; width:36px; height:36px; display:grid; place-items:center; border-radius:10px; background:rgba(30,58,138,.08)}
    .qa strong{font-size:1rem}
    .qa:hover{transform:translateY(-2px); box-shadow:var(--shadow-md)}
    .qa:focus-visible{outline:2px solid var(--primary-blue); outline-offset:2px}

    /* KPI Cards */
    .kpis{display:grid; grid-template-columns:repeat(4,1fr); gap:1rem; margin:.3rem 0 1.2rem}
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:14px; padding:1rem; box-shadow:var(--shadow-sm); min-height:108px; display:flex; flex-direction:column; justify-content:space-between;
    }
    .card h4{font-size:.92rem; color:var(--muted); font-weight:700}
    .card .val{font-size:1.65rem; font-weight:800; color:#0f172a}
    .trend{font-size:.85rem}
    .trend.up{color:var(--good)} .trend.down{color:var(--danger)}
    .skeleton{
      position:relative; overflow:hidden; border-radius:10px; background:linear-gradient(90deg,#eceff4,#f5f7fb,#eceff4); height:22px;
      background-size:200% 100%; animation:skeleton 1.1s linear infinite;
    }
    @keyframes skeleton{0%{background-position:200% 0}100%{background-position:-200% 0}}

    /* Two-column layout: table + tips */
    .grid-2{display:grid; grid-template-columns:3fr 2fr; gap:1rem; margin-top:.6rem}
    .panel{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:1rem; box-shadow:var(--shadow-sm)}
    .panel h3{font-family:'Playfair Display',serif; font-size:1.35rem; color:var(--primary-blue); margin-bottom:.6rem}

    /* Table */
    .table{width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:12px; border:1px solid var(--border)}
    .table thead th{background:#f8fafc; text-align:left; padding:.75rem .85rem; font-size:.9rem; color:#334155; border-bottom:1px solid var(--border)}
    .table tbody td{padding:.7rem .85rem; border-bottom:1px solid var(--border); font-size:.95rem}
    .badge{display:inline-block; padding:.2rem .5rem; border-radius:999px; font-size:.78rem; border:1px solid var(--border); background:#f1f5f9}
    .status.ok{background:rgba(34,197,94,.12); color:#065f46; border-color:rgba(34,197,94,.25)}
    .status.warn{background:rgba(234,179,8,.15); color:#78350f; border-color:rgba(234,179,8,.3)}
    .status.err{background:rgba(239,68,68,.15); color:#7f1d1d; border-color:rgba(239,68,68,.3)}

    /* Toast */
    #toast{
      position:fixed; left:50%; bottom:22px; transform:translateX(-50%); min-width:260px; max-width:86vw;
      padding:.85rem 1rem; border-radius:12px; color:#0f172a; background:#fff; border:1px solid var(--border); box-shadow:var(--shadow-md);
      opacity:0; pointer-events:none; transition:opacity .25s ease, translate .25s ease; translate:0 10px; z-index:9999;
    }
    #toast.show{opacity:1; pointer-events:auto; translate:0 0}
    #toast.success{border-color:rgba(34,197,94,.35)}
    #toast.error{border-color:rgba(239,68,68,.35)}
    #toast .tmsg{display:flex; align-items:center; gap:.55rem; font-weight:700}
    #toast .tmsg i{font-size:1rem}

    /* Footer mini */
    footer{max-width:1280px; margin:1.2rem auto 2.4rem; padding:0 1rem; color:var(--muted); font-size:.9rem}

    /* Mobile */
    @media (max-width: 980px){
      .kpis{grid-template-columns:repeat(2,1fr)}
      .quick-actions{grid-template-columns:repeat(2,1fr)}
      .grid-2{grid-template-columns:1fr}
    }
    @media (max-width: 520px){
      nav a{flex:1 1 46%; font-size:.98rem; padding:.7rem}
      .title-group h1{font-size:1.45rem}
      .title-group span{font-size:.9rem}
      header img{height:48px; width:48px}
    }
  </style>
</head>
<body>
  <!-- Accessible toast (ARIA live region) -->
  <div id="toast" role="status" aria-live="polite" aria-atomic="true"><span class="tmsg"></span></div>

  <!-- Header -->
  <header>
    <div class="brand">
      <img src="https://i.postimg.cc/pXmq7b3r/download-3.jpg" alt="Virtual Herbal Garden Logo" />
      <div class="title-group">
        <h1>Virtual Herbal Garden</h1>
        <span>Admin Portal</span>
      </div>
    </div>

    <div class="top-right">
      <a class="pill" href="/docs/admin-guide.pdf" target="_blank" rel="noopener">
        <i class="fa-solid fa-book-open"></i> Guide
      </a>
      <a class="pill" href="/status" target="_blank" rel="noopener" title="System status">
        <i class="fa-solid fa-signal"></i> Status
      </a>
      <button class="logout" id="logoutBtn" type="button" aria-label="Logout"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
    </div>
  </header>

  <!-- Nav -->
  <nav aria-label="Primary">
    <a href="adminplants.html"><i class="fa-solid fa-seedling"></i> Plants</a>
    <a href="admincategories.html"><i class="fa-solid fa-layer-group"></i> Categories</a>
    <a href="admintours.html"><i class="fa-solid fa-vr-cardboard"></i> Virtual Tours</a>
    <a href="adminprogress.html"><i class="fa-solid fa-chart-line"></i> Progress</a>
    <a href="admindashboard.html" class="active"><i class="fa-solid fa-gauge-high"></i> Overview</a>
  </nav>

  <!-- Main -->
  <main class="container">
    <section class="content" aria-labelledby="welcome">
      <h2 id="welcome">Welcome, <span id="admin-name">Admin</span> ðŸŽ‰</h2>
      <p class="lead">Use the quick actions below, review KPIs, and keep the garden thriving with high-quality content and learning outcomes.</p>

      <!-- Quick actions -->
      <div class="quick-actions" role="list">
        <a class="qa" href="adminplants.html#add" role="listitem">
          <div class="ico"><i class="fa-solid fa-plus"></i></div>
          <div><strong>Add Plant</strong><div class="sub muted">Create a new plant entry</div></div>
        </a>
        <a class="qa" href="admintours.html#new" role="listitem">
          <div class="ico"><i class="fa-solid fa-route"></i></div>
          <div><strong>Create Tour</strong><div class="sub muted">Build an immersive path</div></div>
        </a>
        <a class="qa" href="admincategories.html#manage" role="listitem">
          <div class="ico"><i class="fa-solid fa-tags"></i></div>
          <div><strong>Manage Tags</strong><div class="sub muted">Themes & filters</div></div>
        </a>
        <a class="qa" href="adminprogress.html#quizzes" role="listitem">
          <div class="ico"><i class="fa-solid fa-clipboard-check"></i></div>
          <div><strong>Launch Quiz</strong><div class="sub muted">Assess & track learning</div></div>
        </a>
      </div>

      <!-- KPI Cards -->
      <div class="kpis" id="kpi-cards" aria-live="polite">
        <!-- Skeletons first; JS will hydrate -->
        <div class="card">
          <h4>Total Plants Published</h4>
          <div class="val"><div class="skeleton" style="width:90px"></div></div>
          <div class="trend"><div class="skeleton" style="width:60px; height:16px"></div></div>
        </div>
        <div class="card">
          <h4>Active Virtual Tours</h4>
          <div class="val"><div class="skeleton" style="width:80px"></div></div>
          <div class="trend"><div class="skeleton" style="width:50px; height:16px"></div></div>
        </div>
        <div class="card">
          <h4>Avg Quiz Score</h4>
          <div class="val"><div class="skeleton" style="width:70px"></div></div>
          <div class="trend"><div class="skeleton" style="width:70px; height:16px"></div></div>
        </div>
        <div class="card">
          <h4>Broken Media Links</h4>
          <div class="val"><div class="skeleton" style="width:60px"></div></div>
          <div class="trend"><div class="skeleton" style="width:60px; height:16px"></div></div>
        </div>
      </div>

      <!-- Table + Tips -->
      <div class="grid-2">
        <section class="panel" aria-labelledby="recent-activity">
          <h3 id="recent-activity">Recent Activity</h3>
          <table class="table" id="activity-table">
            <thead>
              <tr>
                <th style="width:32%">Item</th>
                <th style="width:18%">Type</th>
                <th style="width:18%">Status</th>
                <th style="width:18%">By</th>
                <th style="width:14%">Time</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="5" style="padding:1rem; color:var(--muted)">Loading activityâ€¦</td></tr>
            </tbody>
          </table>
        </section>

        <aside class="panel" aria-labelledby="ops-tips">
          <h3 id="ops-tips">Content Quality Checklist</h3>
          <ul style="margin-left:1.1rem; display:grid; gap:.45rem">
            <li>Every plant has: cover image, at least one gallery asset, and (optionally) a 3D model.</li>
            <li>Scientific name, aliases, AYUSH system, parts used, indications filled.</li>
            <li>Dosage & contraindications reviewed by an editor (second eyes).</li>
            <li>Tours have min 4 steps, narration, and one interactive hotspot.</li>
            <li>Quizzes include feedback per option and a pass mark.</li>
            <li>Broken links cleared (Media â†’ Health Monitor).</li>
          </ul>
        </aside>
      </div>
    </section>
  </main>

  <footer>
    <span>&copy; <span id="year"></span> Virtual Herbal Garden â€¢ Secure â€¢ Audited â€¢ Role-based</span>
  </footer>

  <script>
    // ---------- Utilities ----------
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    function showToast(msg, type='success'){
      const t = document.getElementById('toast');
      const wrap = t.querySelector('.tmsg');
      t.classList.remove('success','error','show');
      t.classList.add(type);
      const icon = type === 'success' ? 'fa-circle-check' : 'fa-triangle-exclamation';
      wrap.innerHTML = `<i class="fa-solid ${icon}"></i> ${msg}`;
      // Force reflow for restart animation
      void t.offsetWidth;
      t.classList.add('show');
      clearTimeout(showToast._timer);
      showToast._timer = setTimeout(()=> t.classList.remove('show'), 2200);
    }

    async function apiGet(url){
      const res = await fetch(url, { method:'GET', credentials:'include', cache:'no-store' });
      if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      return res.json();
    }

    function setActiveNav(){
      const path = location.pathname.split('/').pop() || 'admindashboard.html';
      $$('nav a').forEach(a => {
        if(a.getAttribute('href') === path){ a.classList.add('active'); }
        else { a.classList.remove('active'); }
      });
    }

    function hydrateYear(){ $('#year').textContent = new Date().getFullYear(); }

    // ---------- Auth Check ----------
    async function checkAuth(){
      try{
        const data = await apiGet('/api/auth/check');
        const name = data?.user?.name || 'Admin';
        document.getElementById('admin-name').textContent = name;
      }catch(err){
        console.error('Auth check failed:', err);
        showToast(`Authentication required`, 'error');
        setTimeout(()=> location.href = '/admin.html', 1200);
      }
    }

    // ---------- KPIs & Activity ----------
    function renderKPIs(k){
      const tpl = (title, value, trendText, trendUp=true) => `
        <div class="card" role="group" aria-label="${title}">
          <h4>${title}</h4>
          <div class="val">${value}</div>
          <div class="trend ${trendUp?'up':'down'}">
            <i class="fa-solid ${trendUp?'fa-arrow-up-right':'fa-arrow-down-right'}"></i>
            ${trendText}
          </div>
        </div>`;
      const html = [
        tpl('Total Plants Published', k.totalPlants ?? 0, (k.plantDelta ?? 0) + '% vs last week', (k.plantDelta ?? 0) >= 0),
        tpl('Active Virtual Tours', k.activeTours ?? 0, (k.tourDelta ?? 0) + '% vs last week', (k.tourDelta ?? 0) >= 0),
        tpl('Avg Quiz Score', (k.avgScore != null ? k.avgScore + '%' : 'â€”'), 'last 7 days', true),
        tpl('Broken Media Links', k.brokenLinks ?? 0, (k.brokenDelta ?? 0) + ' since scan', (k.brokenDelta ?? 0) <= 0)
      ].join('');
      document.getElementById('kpi-cards').innerHTML = html;
    }

    function renderActivity(rows){
      const tbody = $('#activity-table tbody');
      if(!rows?.length){
        tbody.innerHTML = `<tr><td colspan="5" style="padding:1rem; color:var(--muted)">No recent activity.</td></tr>`;
        return;
      }
      const fmt = new Intl.DateTimeFormat(undefined, { hour:'2-digit', minute:'2-digit', day:'2-digit', month:'short' });
      tbody.innerHTML = rows.slice(0,8).map(r => `
        <tr>
          <td>${escapeHtml(r.item || 'â€”')}</td>
          <td><span class="badge">${escapeHtml(r.type || 'â€”')}</span></td>
          <td><span class="badge status ${statusClass(r.status)}">${escapeHtml(r.status || 'â€”')}</span></td>
          <td>${escapeHtml(r.by || 'â€”')}</td>
          <td>${r.time ? fmt.format(new Date(r.time)) : 'â€”'}</td>
        </tr>
      `).join('');
    }

    function statusClass(s){
      s = (s||'').toLowerCase();
      if(['published','ok','active','passed'].includes(s)) return 'ok';
      if(['pending','review','queued','warn'].includes(s)) return 'warn';
      return 'err';
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    async function loadOverview(){
      try{
        // These endpoints are suggestions; adjust to your backend.
        const [kpis, activity] = await Promise.allSettled([
          apiGet('/api/admin/overview'),
          apiGet('/api/admin/activity?limit=8')
        ]);

        if(kpis.status === 'fulfilled') renderKPIs(kpis.value);
        else renderKPIs({ totalPlants:0, plantDelta:0, activeTours:0, tourDelta:0, avgScore:0, brokenLinks:0, brokenDelta:0 });

        if(activity.status === 'fulfilled') renderActivity(activity.value?.items || activity.value);
        else renderActivity([]);
      }catch(err){
        console.error('Overview error:', err);
        renderKPIs({ totalPlants:0, plantDelta:0, activeTours:0, tourDelta:0, avgScore:0, brokenLinks:0, brokenDelta:0 });
        renderActivity([]);
      }
    }

    // ---------- Logout ----------
    async function logout(){
      try{
        const res = await fetch('/api/auth/logout', { method:'POST', credentials:'include', cache:'no-store' });
        if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
        showToast('Logged out successfully','success');
        setTimeout(()=> location.href = '/admin.html', 800);
      }catch(err){
        console.error('Logout failed:', err);
        showToast('Logout failed','error');
      }
    }

    // ---------- Init ----------
    document.addEventListener('DOMContentLoaded', async () => {
      setActiveNav();
      hydrateYear();
      $('#logoutBtn').addEventListener('click', logout);
      await checkAuth();
      await loadOverview();
    });
  </script>
</body>
</html>
